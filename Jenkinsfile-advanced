pipeline {
    agent any

    triggers {
        pollSCM('H/5 * * * *')
    }

    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipStagesAfterUnstable()
        timestamps()
    }

    environment {
        DOCKER_IMAGE = 'kkaann/myapp'
        IMAGE_TAG = "${BUILD_NUMBER}"
        KIND_CLUSTER = 'kind'
        KUBECONFIG = 'C:\\ProgramData\\Jenkins\\.jenkins\\kind-kubeconfig.yaml'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Checking out code...'
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'ğŸ³ Building Docker image...'
                script {
                    bat """
                        docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} .
                        docker tag ${DOCKER_IMAGE}:${IMAGE_TAG} ${DOCKER_IMAGE}:latest
                    """
                }
            }
        }

        stage('Run Unit Tests') {
            steps {
                echo 'âœ… Running unit tests...'
                bat 'npm install'
                bat 'npm test'
            }
        }

        stage('Security Scan') {
            steps {
                echo 'ğŸ”’ Running security scan...'
                script {
                    bat """
                        docker run --rm ${DOCKER_IMAGE}:${IMAGE_TAG} npm audit --audit-level=high || echo "âœ… Security check complete"
                    """
                }
            }
        }

        stage('Load Image to Kind') {
            steps {
                echo 'ğŸ“¦ Loading image to Kind cluster...'
                script {
                    bat """
                        kind load docker-image ${DOCKER_IMAGE}:${IMAGE_TAG} --name ${KIND_CLUSTER}
                        kind load docker-image ${DOCKER_IMAGE}:latest --name ${KIND_CLUSTER}
                    """
                }
            }
        }

        stage('Deploy to Dev') {
            steps {
                echo 'ğŸš€ Deploying to Dev environment...'
                script {
                    bat """
                        kubectl apply -f environments/dev/deployment.yaml
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n dev
                        kubectl rollout status deployment/myapp -n dev --timeout=2m
                    """
                }
            }
        }

        stage('Smoke Test - Dev') {
            steps {
                echo 'ğŸ§ª Running smoke tests on Dev...'
                script {
                    bat """
                        kubectl wait --for=condition=ready pod -l app=myapp -n dev --timeout=60s
                        kubectl get pods -n dev -l app=myapp
                    """
                    
                    bat "kubectl get pods -n dev -l app=myapp -o jsonpath=\"{.items[0].metadata.name}\" > pod.txt"
                    def podName = readFile('pod.txt').trim()
                    echo "Testing pod: ${podName}"
                    
                    bat "kubectl exec ${podName} -n dev -- wget -O- -q http://localhost:3000/health"
                    echo "âœ… Dev smoke test passed!"
                }
            }
        }

        stage('Deploy to Test') {
            steps {
                echo 'ğŸ§ª Deploying to Test environment...'
                script {
                    bat """
                        kubectl apply -f environments/test/deployment.yaml
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n test
                        kubectl rollout status deployment/myapp -n test --timeout=2m
                    """
                }
            }
        }

        stage('Smoke Test - Test') {
            steps {
                echo 'ğŸ§ª Testing Test environment...'
                script {
                    bat """
                        kubectl wait --for=condition=ready pod -l app=myapp -n test --timeout=60s
                        kubectl get pods -n test -l app=myapp
                    """
                    
                    bat "kubectl get pods -n test -l app=myapp -o jsonpath=\"{.items[0].metadata.name}\" > pod.txt"
                    def podName = readFile('pod.txt').trim()
                    echo "Testing pod: ${podName}"
                    
                    bat "kubectl exec ${podName} -n test -- wget -O- -q http://localhost:3000/health"
                    echo "âœ… Test smoke test passed!"
                }
            }
        }

        stage('Deploy to Prod') {
            steps {
                echo 'ğŸŒŸ Deploying to Production...'
                script {
                    bat """
                        kubectl apply -f environments/prod/deployment.yaml
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n prod
                        kubectl rollout status deployment/myapp -n prod --timeout=3m
                    """
                }
            }
        }

        stage('Smoke Test - Prod') {
            steps {
                echo 'âœ… Testing Production...'
                script {
                    bat """
                        kubectl wait --for=condition=ready pod -l app=myapp -n prod --timeout=90s
                        kubectl get pods -n prod -l app=myapp
                    """
                    
                    bat "kubectl get pods -n prod -l app=myapp -o jsonpath=\"{.items[0].metadata.name}\" > pod.txt"
                    def podName = readFile('pod.txt').trim()
                    echo "Testing pod: ${podName}"
                    
                    bat "kubectl exec ${podName} -n prod -- wget -O- -q http://localhost:3000/health"
                    echo "âœ… Prod smoke test passed!"
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âœ… PIPELINE COMPLETED SUCCESSFULLY!'
            echo "âœ… Docker Image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
            echo 'âœ… Deployed to: DEV â†’ TEST â†’ PROD'
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            script {
                bat """
                    echo.
                    echo === ğŸ”¹ DEV Environment ===
                    kubectl get pods -n dev -l app=myapp -o wide
                    echo.
                    echo === ğŸ”¹ TEST Environment ===
                    kubectl get pods -n test -l app=myapp -o wide
                    echo.
                    echo === ğŸ”¹ PROD Environment ===
                    kubectl get pods -n prod -l app=myapp -o wide
                    echo.
                    echo âœ… All environments deployed successfully!
                """
            }
        }
        failure {
            echo 'âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âŒ PIPELINE FAILED!'
            echo 'âŒ Check the logs above for details'
            echo 'âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
        }
        always {
            echo 'ğŸ§¹ Cleaning up Docker images...'
            bat 'docker image prune -f || exit /b 0'
        }
    }
}
