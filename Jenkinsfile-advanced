pipeline {
    agent any

    triggers {
        pollSCM('H/5 * * * *')
    }

    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipStagesAfterUnstable()
        timestamps()
    }

    environment {
        DOCKER_IMAGE = 'kkaann/myapp'
        IMAGE_TAG = "${BUILD_NUMBER}"
        KIND_CLUSTER = 'kind'
        DEV_NAMESPACE = 'dev'
        TEST_NAMESPACE = 'test'
        PROD_NAMESPACE = 'prod'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Checking out code...'
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'ğŸ³ Building Docker image...'
                script {
                    bat """
                        docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} .
                        docker tag ${DOCKER_IMAGE}:${IMAGE_TAG} ${DOCKER_IMAGE}:latest
                    """
                }
            }
        }

        stage('Run Unit Tests') {
            steps {
                echo 'âœ… Running unit tests...'
                bat 'npm install'
                bat 'npm test'
            }
        }

        stage('Security Scan') {
            steps {
                echo 'ğŸ”’ Running security scan...'
                script {
                    bat """
                        docker run --rm ${DOCKER_IMAGE}:${IMAGE_TAG} npm audit --audit-level=high || echo "Security issues found but continuing..."
                    """
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                echo 'ğŸ“¤ Pushing to Docker Hub...'
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        bat '''
                            echo %DOCKER_PASS% | docker login -u %DOCKER_USER% --password-stdin
                            docker push %DOCKER_IMAGE%:%IMAGE_TAG%
                            docker push %DOCKER_IMAGE%:latest
                            docker logout
                        '''
                    }
                }
            }
        }

        stage('Load Image to Kind') {
            steps {
                echo 'ğŸ“¦ Loading image to Kind cluster...'
                script {
                    bat "kind load docker-image ${DOCKER_IMAGE}:${IMAGE_TAG} --name ${KIND_CLUSTER}"
                }
            }
        }

        stage('Deploy to Dev') {
            steps {
                echo 'ğŸš€ Deploying to Dev environment...'
                script {
                    bat """
                        kubectl get namespace ${DEV_NAMESPACE} || kubectl create namespace ${DEV_NAMESPACE}
                        kubectl apply -f environments/dev/deployment.yaml -n ${DEV_NAMESPACE}
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n ${DEV_NAMESPACE}
                        kubectl rollout status deployment/myapp -n ${DEV_NAMESPACE} --timeout=3m
                    """
                }
            }
        }

        stage('Smoke Test - Dev') {
            steps {
                echo 'ğŸ§ª Running smoke tests on Dev...'
                script {
                    sleep(time: 5, unit: 'SECONDS')
                    bat """
                        powershell -Command "\$podName = (kubectl get pods -n ${DEV_NAMESPACE} -l app=myapp -o jsonpath='{.items[0].metadata.name}'); Write-Host 'Testing pod:' \$podName; kubectl exec \$podName -n ${DEV_NAMESPACE} -- wget -O- -q http://localhost:3000/health"
                    """
                }
            }
        }

        stage('Integration Tests') {
            steps {
                echo 'ğŸ”— Running integration tests...'
                script {
                    bat """
                        powershell -Command "\$podName = (kubectl get pods -n ${DEV_NAMESPACE} -l app=myapp -o jsonpath='{.items[0].metadata.name}'); kubectl exec \$podName -n ${DEV_NAMESPACE} -- wget -O- -q http://localhost:3000 | findstr 'My Kubernetes App'"
                    """
                }
            }
        }

        stage('Deploy to Test') {
            steps {
                echo 'ğŸ§ª Deploying to Test environment...'
                script {
                    bat """
                        kubectl get namespace ${TEST_NAMESPACE} || kubectl create namespace ${TEST_NAMESPACE}
                        kubectl apply -f environments/test/deployment.yaml -n ${TEST_NAMESPACE}
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n ${TEST_NAMESPACE}
                        kubectl rollout status deployment/myapp -n ${TEST_NAMESPACE} --timeout=3m
                    """
                }
            }
        }

        stage('Smoke Test - Test') {
            steps {
                echo 'ğŸ§ª Running smoke tests on Test...'
                script {
                    sleep(time: 5, unit: 'SECONDS')
                    bat """
                        powershell -Command "\$podName = (kubectl get pods -n ${TEST_NAMESPACE} -l app=myapp -o jsonpath='{.items[0].metadata.name}'); kubectl exec \$podName -n ${TEST_NAMESPACE} -- wget -O- -q http://localhost:3000/health"
                    """
                }
            }
        }

        stage('Approve Production Deploy') {
            steps {
                script {
                    echo 'â¸ï¸  Waiting for production deployment approval...'
                    timeout(time: 15, unit: 'MINUTES') {
                        input message: 'ğŸš€ Deploy to Production?',
                              ok: 'Deploy to Prod',
                              submitter: 'admin',
                              parameters: [
                                  choice(name: 'DEPLOY_STRATEGY', 
                                         choices: ['RollingUpdate', 'Recreate'], 
                                         description: 'Deployment strategy')
                              ]
                    }
                }
            }
        }

        stage('Deploy to Prod') {
            steps {
                echo 'ğŸŒŸ Deploying to Production environment...'
                script {
                    bat """
                        kubectl get namespace ${PROD_NAMESPACE} || kubectl create namespace ${PROD_NAMESPACE}
                        kubectl apply -f environments/prod/deployment.yaml -n ${PROD_NAMESPACE}
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n ${PROD_NAMESPACE}
                        kubectl rollout status deployment/myapp -n ${PROD_NAMESPACE} --timeout=5m
                    """
                }
            }
        }

        stage('Smoke Test - Prod') {
            steps {
                echo 'ğŸ§ª Running smoke tests on Production...'
                script {
                    sleep(time: 10, unit: 'SECONDS')
                    bat """
                        powershell -Command "\$podName = (kubectl get pods -n ${PROD_NAMESPACE} -l app=myapp -o jsonpath='{.items[0].metadata.name}'); kubectl exec \$podName -n ${PROD_NAMESPACE} -- wget -O- -q http://localhost:3000/health"
                    """
                }
            }
        }

        stage('Performance Test') {
            steps {
                echo 'âš¡ Running performance tests...'
                script {
                    bat """
                        powershell -Command "Write-Host 'Running 10 health check requests...'; 1..10 | ForEach-Object { \$podName = (kubectl get pods -n ${PROD_NAMESPACE} -l app=myapp -o jsonpath='{.items[0].metadata.name}'); kubectl exec \$podName -n ${PROD_NAMESPACE} -- wget -O- -q http://localhost:3000/health }"
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âœ… Pipeline completed successfully!'
            echo "âœ… Deployed: ${DOCKER_IMAGE}:${IMAGE_TAG}"
            echo 'âœ… Environments:'
            echo "   â€¢ Dev: ${DEV_NAMESPACE} âœ“"
            echo "   â€¢ Test: ${TEST_NAMESPACE} âœ“"
            echo "   â€¢ Prod: ${PROD_NAMESPACE} âœ“"
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            
            script {
                bat """
                    echo.
                    echo âœ… DEPLOYMENT SUMMARY
                    echo ==================
                    kubectl get pods -n dev -l app=myapp
                    echo.
                    kubectl get pods -n test -l app=myapp
                    echo.
                    kubectl get pods -n prod -l app=myapp
                """
            }
        }
        failure {
            echo 'âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âŒ Pipeline failed!'
            echo 'âŒ Check logs above for details'
            echo 'âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            
            script {
                bat """
                    echo.
                    echo âŒ Attempting rollback if needed...
                    kubectl rollout undo deployment/myapp -n ${DEV_NAMESPACE} || echo "No rollback needed for dev"
                    kubectl rollout undo deployment/myapp -n ${TEST_NAMESPACE} || echo "No rollback needed for test"
                """
            }
        }
        always {
            echo 'ğŸ§¹ Cleaning up...'
            bat """
                docker image prune -f
                docker logout || echo "Already logged out"
            """
            
            script {
                bat """
                    echo.
                    echo ğŸ“Š RESOURCE USAGE
                    echo ================
                    kubectl top nodes || echo "Metrics not available"
                """
            }
        }
    }
}