pipeline {
    agent any
    
    triggers {
        pollSCM('H/5 * * * *')  // Poll every 5 minutes
    }
    
    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipStagesAfterUnstable()
    }
    
    environment {
        DOCKER_IMAGE = 'kkaann/myapp'
        IMAGE_TAG = "${BUILD_NUMBER}"
        KIND_CLUSTER = 'kind'
        NAMESPACE = 'dev'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out code...'
                checkout scm
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                script {
                    bat """
                        docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} .
                        docker tag ${DOCKER_IMAGE}:${IMAGE_TAG} ${DOCKER_IMAGE}:latest
                    """
                }
            }
        }
        
        stage('Test') {
            steps {
                echo '‚úÖ Running tests...'
                bat 'npm install'
                bat 'npm test'
            }
        }
        
        stage('Load Image to Kind') {
            steps {
                echo 'üì¶ Loading image to Kind cluster...'
                script {
                    bat "kind load docker-image ${DOCKER_IMAGE}:${IMAGE_TAG} --name ${KIND_CLUSTER}"
                }
            }
        }
        
        stage('Deploy to Dev') {
            steps {
                echo 'üöÄ Deploying to Kubernetes...'
                script {
                    // Create namespace if it doesn't exist
                    bat """
                        kubectl get namespace ${NAMESPACE} || kubectl create namespace ${NAMESPACE}
                    """
                    
                    // Update deployment with new image tag
                    bat """
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n ${NAMESPACE} --record || echo "Deployment not found, applying from file..."
                    """
                    
                    // Apply manifests
                    bat """
                        kubectl apply -f environments/dev/deployment.yaml -n ${NAMESPACE}
                    """
                    
                    // Wait for rollout
                    bat """
                        kubectl rollout status deployment/myapp -n ${NAMESPACE} --timeout=5m
                    """
                }
            }
        }
        
        stage('Smoke Test') {
            steps {
                echo 'üß™ Running smoke tests...'
                script {
                    sleep(time: 10, unit: 'SECONDS')
                    
                    // Get pod name
                    def podName = bat(
                        script: "kubectl get pods -n ${NAMESPACE} -l app=myapp -o jsonpath=\"{.items[0].metadata.name}\"",
                        returnStdout: true
                    ).trim()
                    
                    echo "Testing pod: ${podName}"
                    
                    // Test health endpoint via port-forward
                    bat """
                        kubectl exec ${podName} -n ${NAMESPACE} -- curl -s http://localhost:3000/health
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Pipeline completed successfully!'
            echo "Deployed: ${DOCKER_IMAGE}:${IMAGE_TAG}"
        }
        failure {
            echo '‚ùå Pipeline failed! Check logs above.'
        }
        always {
            echo 'üßπ Cleaning up...'
            // Clean old Docker images
            bat """
                docker image prune -f
            """
        }
    }
}
