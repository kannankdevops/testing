pipeline {
    agent any

    triggers {
        pollSCM('H/5 * * * *')
    }

    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipStagesAfterUnstable()
        timestamps()
    }

    environment {
        DOCKER_IMAGE = 'kkaann/myapp'
        IMAGE_TAG = "${BUILD_NUMBER}"
        KIND_CLUSTER = 'kind'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Checking out code...'
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'ğŸ³ Building Docker image...'
                script {
                    bat """
                        docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} .
                        docker tag ${DOCKER_IMAGE}:${IMAGE_TAG} ${DOCKER_IMAGE}:latest
                    """
                }
            }
        }

        stage('Run Unit Tests') {
            steps {
                echo 'âœ… Running unit tests...'
                bat 'npm install'
                bat 'npm test'
            }
        }

        stage('Security Scan') {
            steps {
                echo 'ğŸ”’ Running security scan...'
                script {
                    bat """
                        docker run --rm ${DOCKER_IMAGE}:${IMAGE_TAG} npm audit --audit-level=high || echo "Security check complete"
                    """
                }
            }
        }

        stage('Load Image to Kind') {
            steps {
                echo 'ğŸ“¦ Loading image to Kind cluster...'
                script {
                    bat "kind load docker-image ${DOCKER_IMAGE}:${IMAGE_TAG} --name ${KIND_CLUSTER}"
                }
            }
        }

        stage('Deploy to Dev') {
            steps {
                echo 'ğŸš€ Deploying to Dev...'
                script {
                    // Use direct kubectl commands without namespace check
                    bat """
                        kubectl apply -f environments/dev/deployment.yaml
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n dev
                        kubectl rollout status deployment/myapp -n dev --timeout=3m
                    """
                }
            }
        }

        stage('Smoke Test - Dev') {
            steps {
                echo 'ğŸ§ª Running smoke tests...'
                script {
                    sleep(time: 10, unit: 'SECONDS')
                    bat """
                        powershell -Command "\$podName = (kubectl get pods -n dev -l app=myapp -o jsonpath='{.items[0].metadata.name}'); kubectl exec \$podName -n dev -- wget -O- -q http://localhost:3000/health"
                    """
                }
            }
        }

        stage('Deploy to Test') {
            steps {
                echo 'ğŸ§ª Deploying to Test...'
                script {
                    bat """
                        kubectl apply -f environments/test/deployment.yaml
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n test
                        kubectl rollout status deployment/myapp -n test --timeout=3m
                    """
                }
            }
        }

        stage('Smoke Test - Test') {
            steps {
                echo 'ğŸ§ª Testing Test environment...'
                script {
                    sleep(time: 10, unit: 'SECONDS')
                    bat """
                        powershell -Command "\$podName = (kubectl get pods -n test -l app=myapp -o jsonpath='{.items[0].metadata.name}'); kubectl exec \$podName -n test -- wget -O- -q http://localhost:3000/health"
                    """
                }
            }
        }

        stage('Approve Production') {
            steps {
                echo 'â¸ï¸  Waiting for approval...'
                timeout(time: 15, unit: 'MINUTES') {
                    input message: 'ğŸš€ Deploy to Production?',
                          ok: 'Deploy',
                          submitter: 'admin'
                }
            }
        }

        stage('Deploy to Prod') {
            steps {
                echo 'ğŸŒŸ Deploying to Production...'
                script {
                    bat """
                        kubectl apply -f environments/prod/deployment.yaml
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n prod
                        kubectl rollout status deployment/myapp -n prod --timeout=5m
                    """
                }
            }
        }

        stage('Smoke Test - Prod') {
            steps {
                echo 'âœ… Testing Production...'
                script {
                    sleep(time: 15, unit: 'SECONDS')
                    bat """
                        powershell -Command "\$podName = (kubectl get pods -n prod -l app=myapp -o jsonpath='{.items[0].metadata.name}'); kubectl exec \$podName -n prod -- wget -O- -q http://localhost:3000/health"
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âœ… Pipeline SUCCESS!'
            echo "âœ… Image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            script {
                bat """
                    kubectl get pods -n dev -l app=myapp
                    kubectl get pods -n test -l app=myapp
                    kubectl get pods -n prod -l app=myapp
                """
            }
        }
        failure {
            echo 'âŒ Pipeline FAILED! Check logs above.'
        }
        always {
            echo 'ğŸ§¹ Cleaning up...'
            bat 'docker image prune -f'
        }
    }
}