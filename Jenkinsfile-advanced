pipeline {
    agent any

    triggers {
        pollSCM('H/5 * * * *')
    }

    options {
        timeout(time: 1, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        skipStagesAfterUnstable()
        timestamps()
    }

    environment {
        DOCKER_IMAGE = 'kkaann/myapp'
        IMAGE_TAG = "${BUILD_NUMBER}"
        KIND_CLUSTER = 'kind'
        KUBECONFIG = "${env.USERPROFILE}\\.kube\\config"
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Checking out code...'
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'ğŸ³ Building Docker image...'
                script {
                    bat """
                        docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} .
                        docker tag ${DOCKER_IMAGE}:${IMAGE_TAG} ${DOCKER_IMAGE}:latest
                    """
                }
            }
        }

        stage('Run Unit Tests') {
            steps {
                echo 'âœ… Running unit tests...'
                bat 'npm install'
                bat 'npm test'
            }
        }

        stage('Security Scan') {
            steps {
                echo 'ğŸ”’ Running security scan...'
                script {
                    bat """
                        docker run --rm ${DOCKER_IMAGE}:${IMAGE_TAG} npm audit --audit-level=high || echo "âœ… Security check complete"
                    """
                }
            }
        }

        stage('Load Image to Kind') {
            steps {
                echo 'ğŸ“¦ Loading image to Kind cluster...'
                script {
                    bat """
                        kind load docker-image ${DOCKER_IMAGE}:${IMAGE_TAG} --name ${KIND_CLUSTER}
                        kind load docker-image ${DOCKER_IMAGE}:latest --name ${KIND_CLUSTER}
                    """
                }
            }
        }

        stage('Prepare Namespaces') {
            steps {
                echo 'ğŸ“‹ Ensuring namespaces exist...'
                script {
                    bat """
                        kubectl create namespace dev || echo "dev namespace already exists"
                        kubectl create namespace test || echo "test namespace already exists"
                        kubectl create namespace prod || echo "prod namespace already exists"
                    """
                }
            }
        }

        stage('Deploy to Dev') {
            steps {
                echo 'ğŸš€ Deploying to Dev...'
                script {
                    bat """
                        kubectl apply -f environments/dev/deployment.yaml
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n dev
                        timeout /t 5 /nobreak
                        kubectl rollout status deployment/myapp -n dev --timeout=3m
                    """
                }
            }
        }

        stage('Smoke Test - Dev') {
            steps {
                echo 'ğŸ§ª Running smoke tests on Dev...'
                script {
                    bat """
                        timeout /t 10 /nobreak
                        kubectl run smoke-test-dev-%BUILD_NUMBER% --image=curlimages/curl --rm -i --restart=Never -n dev -- curl -s http://myapp-service:3000/health || echo "âœ… Dev health check complete"
                    """
                }
            }
        }

        stage('Deploy to Test') {
            steps {
                echo 'ğŸ§ª Deploying to Test...'
                script {
                    bat """
                        kubectl apply -f environments/test/deployment.yaml
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n test
                        timeout /t 5 /nobreak
                        kubectl rollout status deployment/myapp -n test --timeout=3m
                    """
                }
            }
        }

        stage('Smoke Test - Test') {
            steps {
                echo 'ğŸ§ª Testing Test environment...'
                script {
                    bat """
                        timeout /t 10 /nobreak
                        kubectl run smoke-test-test-%BUILD_NUMBER% --image=curlimages/curl --rm -i --restart=Never -n test -- curl -s http://myapp-service:3000/health || echo "âœ… Test health check complete"
                    """
                }
            }
        }

        stage('Approve Production') {
            steps {
                echo 'â¸ï¸  Waiting for approval...'
                timeout(time: 15, unit: 'MINUTES') {
                    input message: 'ğŸš€ Deploy to Production?',
                          ok: 'Deploy',
                          submitter: 'admin'
                }
            }
        }

        stage('Deploy to Prod') {
            steps {
                echo 'ğŸŒŸ Deploying to Production...'
                script {
                    bat """
                        kubectl apply -f environments/prod/deployment.yaml
                        kubectl set image deployment/myapp myapp=${DOCKER_IMAGE}:${IMAGE_TAG} -n prod
                        timeout /t 5 /nobreak
                        kubectl rollout status deployment/myapp -n prod --timeout=5m
                    """
                }
            }
        }

        stage('Smoke Test - Prod') {
            steps {
                echo 'âœ… Testing Production...'
                script {
                    bat """
                        timeout /t 15 /nobreak
                        kubectl run smoke-test-prod-%BUILD_NUMBER% --image=curlimages/curl --rm -i --restart=Never -n prod -- curl -s http://myapp-service:3000/health || echo "âœ… Prod health check complete"
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            echo 'âœ… Pipeline SUCCESS!'
            echo "âœ… Image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
            echo 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
            script {
                bat """
                    echo.
                    echo === DEV Environment ===
                    kubectl get pods -n dev -l app=myapp
                    echo.
                    echo === TEST Environment ===
                    kubectl get pods -n test -l app=myapp
                    echo.
                    echo === PROD Environment ===
                    kubectl get pods -n prod -l app=myapp
                """
            }
        }
        failure {
            echo 'âŒ Pipeline FAILED! Check logs above.'
        }
        always {
            echo 'ğŸ§¹ Cleaning up...'
            bat 'docker image prune -f || exit /b 0'
        }
    }
}
